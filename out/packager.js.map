{
  "version": 3,
  "file": "packager.js",
  "sourceRoot": "",
  "sources": [
    "../src/packager.ts"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "import * as path from \"path\"\r\nimport {\r\n  computeDefaultAppDirectory, installDependencies, log, getElectronVersion, readPackageJson, use, warn,\r\n  exec, isEmptyOrSpaces\r\n} from \"./util\"\r\nimport { all, executeFinally } from \"./promise\"\r\nimport { EventEmitter } from \"events\"\r\nimport { Promise as BluebirdPromise } from \"bluebird\"\r\nimport { InfoRetriever } from \"./repositoryInfo\"\r\nimport { AppMetadata, DevMetadata, Platform, Arch } from \"./metadata\"\r\nimport { PackagerOptions, PlatformPackager, BuildInfo, ArtifactCreated, computeEffectiveTargets, commonTargets } from \"./platformPackager\"\r\nimport OsXPackager from \"./osxPackager\"\r\nimport { WinPackager } from \"./winPackager\"\r\nimport * as errorMessages from \"./errorMessages\"\r\nimport * as util from \"util\"\r\nimport deepAssign = require(\"deep-assign\")\r\nimport compareVersions = require(\"compare-versions\")\r\n\r\n//noinspection JSUnusedLocalSymbols\r\nconst __awaiter = require(\"./awaiter\")\r\n\r\nfunction addHandler(emitter: EventEmitter, event: string, handler: Function) {\r\n  emitter.on(event, handler)\r\n}\r\n\r\nexport class Packager implements BuildInfo {\r\n  readonly projectDir: string\r\n  appDir: string\r\n\r\n  metadata: AppMetadata\r\n  devMetadata: DevMetadata\r\n\r\n  isTwoPackageJsonProjectLayoutUsed = true\r\n\r\n  electronVersion: string\r\n\r\n  readonly eventEmitter = new EventEmitter()\r\n\r\n  //noinspection JSUnusedGlobalSymbols\r\n  constructor(public options: PackagerOptions, public repositoryInfo: InfoRetriever | null = null) {\r\n    this.projectDir = options.projectDir == null ? process.cwd() : path.resolve(options.projectDir)\r\n  }\r\n\r\n  artifactCreated(handler: (event: ArtifactCreated) => void): Packager {\r\n    addHandler(this.eventEmitter, \"artifactCreated\", handler)\r\n    return this\r\n  }\r\n\r\n  get devPackageFile(): string {\r\n    return path.join(this.projectDir, \"package.json\")\r\n  }\r\n\r\n  async build(): Promise<any> {\r\n    const devPackageFile = this.devPackageFile\r\n\r\n    this.devMetadata = deepAssign(await readPackageJson(devPackageFile), this.options.devMetadata)\r\n    this.appDir = await computeDefaultAppDirectory(this.projectDir, use(this.devMetadata.directories, it => it!.app))\r\n\r\n    this.isTwoPackageJsonProjectLayoutUsed = this.appDir !== this.projectDir\r\n\r\n    const appPackageFile = this.projectDir === this.appDir ? devPackageFile : path.join(this.appDir, \"package.json\")\r\n    this.metadata = appPackageFile === devPackageFile ? (this.options.appMetadata || this.devMetadata) : deepAssign(await readPackageJson(appPackageFile), this.options.appMetadata)\r\n\r\n    this.checkMetadata(appPackageFile, devPackageFile)\r\n    checkConflictingOptions(this.devMetadata.build)\r\n\r\n    this.electronVersion = await getElectronVersion(this.devMetadata, devPackageFile)\r\n\r\n    const cleanupTasks: Array<() => Promise<any>> = []\r\n    return executeFinally(this.doBuild(cleanupTasks), () => all(cleanupTasks.map(it => it())))\r\n  }\r\n\r\n  private async doBuild(cleanupTasks: Array<() => Promise<any>>): Promise<any> {\r\n    const distTasks: Array<Promise<any>> = []\r\n    const outDir = path.resolve(this.projectDir, use(this.devMetadata.directories, it => it!.output) || \"dist\")\r\n\r\n    // custom packager - don't check wine\r\n    let checkWine = this.options.platformPackagerFactory == null\r\n    for (let [platform, archToType] of this.options.targets!) {\r\n      if (platform === Platform.OSX && process.platform === Platform.WINDOWS.nodeName) {\r\n        throw new Error(\"Build for OS X is supported only on OS X, please see https://github.com/electron-userland/electron-builder/wiki/Multi-Platform-Build\")\r\n      }\r\n\r\n      let wineCheck: Promise<string> | null = null\r\n      if (checkWine && process.platform !== \"win32\" && platform === Platform.WINDOWS) {\r\n        wineCheck = exec(\"wine\", [\"--version\"])\r\n      }\r\n\r\n      const helper = this.createHelper(platform, cleanupTasks)\r\n      for (let [arch, targets] of archToType) {\r\n        await this.installAppDependencies(platform, arch)\r\n\r\n        if (checkWine && wineCheck != null) {\r\n          checkWine = false\r\n          checkWineVersion(wineCheck)\r\n        }\r\n\r\n        // electron-packager uses productName in the directory name\r\n        const effectiveTargets = computeEffectiveTargets(targets, helper.customBuildOptions.target)\r\n        const supportedTargets = helper.supportedTargets.concat(commonTargets)\r\n        for (let target of effectiveTargets) {\r\n          if (target !== \"default\" && !supportedTargets.includes(target)) {\r\n            throw new Error(`Unknown target: ${target}`)\r\n          }\r\n        }\r\n        await helper.pack(outDir, arch, effectiveTargets, distTasks)\r\n      }\r\n    }\r\n\r\n    return await BluebirdPromise.all(distTasks)\r\n  }\r\n\r\n  private createHelper(platform: Platform, cleanupTasks: Array<() => Promise<any>>): PlatformPackager<any> {\r\n    if (this.options.platformPackagerFactory != null) {\r\n      return this.options.platformPackagerFactory!(this,  platform, cleanupTasks)\r\n    }\r\n\r\n    switch (platform) {\r\n      case Platform.OSX:\r\n      {\r\n        const helperClass: typeof OsXPackager = require(\"./osxPackager\").default\r\n        return new helperClass(this, cleanupTasks)\r\n      }\r\n\r\n      case Platform.WINDOWS:\r\n      {\r\n        const helperClass: typeof WinPackager = require(\"./winPackager\").WinPackager\r\n        return new helperClass(this, cleanupTasks)\r\n      }\r\n\r\n      case Platform.LINUX:\r\n        return new (require(\"./linuxPackager\").LinuxPackager)(this, cleanupTasks)\r\n\r\n      default:\r\n        throw new Error(`Unknown platform: ${platform}`)\r\n    }\r\n  }\r\n\r\n  private checkMetadata(appPackageFile: string, devAppPackageFile: string): void {\r\n    const reportError = (missedFieldName: string) => {\r\n      throw new Error(`Please specify '${missedFieldName}' in the application package.json ('${appPackageFile}')`)\r\n    }\r\n\r\n    const checkNotEmpty = (name: string, value: string) => {\r\n      if (isEmptyOrSpaces(value)) {\r\n        reportError(name)\r\n      }\r\n    }\r\n\r\n    const appMetadata = this.metadata\r\n\r\n    checkNotEmpty(\"name\", appMetadata.name)\r\n    checkNotEmpty(\"description\", appMetadata.description)\r\n    checkNotEmpty(\"version\", appMetadata.version)\r\n\r\n    if ((<any>appMetadata) !== this.devMetadata) {\r\n      if ((<any>appMetadata).build != null) {\r\n        throw new Error(util.format(errorMessages.buildInAppSpecified, appPackageFile, devAppPackageFile))\r\n      }\r\n\r\n      if (this.devMetadata.homepage != null) {\r\n        warn(\"homepage in the development package.json is deprecated, please move to the application package.json\")\r\n      }\r\n      if (this.devMetadata.license != null) {\r\n        warn(\"license in the development package.json is deprecated, please move to the application package.json\")\r\n      }\r\n    }\r\n\r\n    if (<any>this.devMetadata.build == null) {\r\n      throw new Error(util.format(errorMessages.buildIsMissed, devAppPackageFile))\r\n    }\r\n    else {\r\n      const author = appMetadata.author\r\n      if (<any>author == null) {\r\n        reportError(\"author\")\r\n      }\r\n      else if (<any>author.email == null && this.options.targets!.has(Platform.LINUX)) {\r\n        throw new Error(util.format(errorMessages.authorEmailIsMissed, appPackageFile))\r\n      }\r\n\r\n      if ((<any>this.devMetadata.build).name != null) {\r\n        throw new Error(util.format(errorMessages.nameInBuildSpecified, appPackageFile))\r\n      }\r\n    }\r\n  }\r\n\r\n  private installAppDependencies(platform: Platform, arch: Arch): Promise<any> {\r\n    if (this.isTwoPackageJsonProjectLayoutUsed) {\r\n      if (this.devMetadata.build.npmRebuild === false) {\r\n        log(\"Skip app dependencies rebuild because npmRebuild is set to false\")\r\n      }\r\n      else if (platform.nodeName === process.platform) {\r\n        return installDependencies(this.appDir, this.electronVersion, Arch[arch], \"rebuild\")\r\n      }\r\n      else {\r\n        log(\"Skip app dependencies rebuild because platform is different\")\r\n      }\r\n    }\r\n    else {\r\n      log(\"Skip app dependencies rebuild because dev and app dependencies are not separated\")\r\n    }\r\n\r\n    return BluebirdPromise.resolve()\r\n  }\r\n}\r\n\r\nexport function normalizePlatforms(rawPlatforms: Array<string | Platform> | string | Platform | n): Array<Platform> {\r\n  const platforms = rawPlatforms == null || Array.isArray(rawPlatforms) ? (<Array<string | Platform | n>>rawPlatforms) : [rawPlatforms]\r\n  if (<any>platforms == null || platforms.length === 0) {\r\n    return [Platform.fromString(process.platform)]\r\n  }\r\n  else if (platforms[0] === \"all\") {\r\n    if (process.platform === Platform.OSX.nodeName) {\r\n      return [Platform.OSX, Platform.LINUX, Platform.WINDOWS]\r\n    }\r\n    else if (process.platform === Platform.LINUX.nodeName) {\r\n      // OS X code sign works only on OS X\r\n      return [Platform.LINUX, Platform.WINDOWS]\r\n    }\r\n    else {\r\n      return [Platform.WINDOWS]\r\n    }\r\n  }\r\n  else {\r\n    return platforms.map(it => it instanceof Platform ? it : Platform.fromString(it!))\r\n  }\r\n}\r\n\r\nfunction checkConflictingOptions(options: any) {\r\n  for (let name of [\"all\", \"out\", \"tmpdir\", \"version\", \"platform\", \"dir\", \"arch\", \"name\"]) {\r\n    if (name in options) {\r\n      throw new Error(`Option ${name} is ignored, do not specify it.`)\r\n    }\r\n  }\r\n}\r\n\r\nasync function checkWineVersion(checkPromise: Promise<string>) {\r\n  function wineError(prefix: string): string {\r\n    return `${prefix}, please see https://github.com/electron-userland/electron-builder/wiki/Multi-Platform-Build#${(process.platform === \"linux\" ? \"linux\" : \"os-x\")}`\r\n  }\r\n\r\n  let wineVersion: string\r\n  try {\r\n    wineVersion = (await checkPromise).trim()\r\n  }\r\n  catch (e) {\r\n    if (e.code === \"ENOENT\") {\r\n      throw new Error(wineError(\"wine is required\"))\r\n    }\r\n    else {\r\n      throw new Error(\"Cannot check wine version: \" + e)\r\n    }\r\n  }\r\n\r\n  if (wineVersion.startsWith(\"wine-\")) {\r\n    wineVersion = wineVersion.substring(\"wine-\".length)\r\n  }\r\n\r\n  if (compareVersions(wineVersion, \"1.8\") === -1) {\r\n    throw new Error(wineError(`wine 1.8+ is required, but your version is ${wineVersion}`))\r\n  }\r\n}"
  ]
}
