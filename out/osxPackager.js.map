{
  "version": 3,
  "file": "osxPackager.js",
  "sourceRoot": "",
  "sources": [
    "../src/osxPackager.ts"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "import { PlatformPackager, BuildInfo } from \"./platformPackager\"\r\nimport { Platform, OsXBuildOptions, MasBuildOptions, Arch } from \"./metadata\"\r\nimport * as path from \"path\"\r\nimport { Promise as BluebirdPromise } from \"bluebird\"\r\nimport { log, debug, warn, isEmptyOrSpaces } from \"./util\"\r\nimport { createKeychain, deleteKeychain, CodeSigningInfo, generateKeychainName, findIdentity, appleCertificatePrefixes, CertType } from \"./codeSign\"\r\nimport deepAssign = require(\"deep-assign\")\r\nimport { signAsync, flatAsync, BaseSignOptions, SignOptions, FlatOptions } from \"electron-osx-sign-tf\"\r\n\r\n//noinspection JSUnusedLocalSymbols\r\nconst __awaiter = require(\"./awaiter\")\r\n\r\nexport default class OsXPackager extends PlatformPackager<OsXBuildOptions> {\r\n  codeSigningInfo: Promise<CodeSigningInfo | null>\r\n\r\n  constructor(info: BuildInfo, cleanupTasks: Array<() => Promise<any>>) {\r\n    super(info)\r\n\r\n    if (this.options.cscLink == null) {\r\n      this.codeSigningInfo = BluebirdPromise.resolve(null)\r\n    }\r\n    else {\r\n      const keychainName = generateKeychainName()\r\n      cleanupTasks.push(() => deleteKeychain(keychainName))\r\n      this.codeSigningInfo = createKeychain(keychainName, this.options.cscLink, this.getCscPassword(), this.options.cscInstallerLink, this.options.cscInstallerKeyPassword)\r\n    }\r\n  }\r\n\r\n  get platform() {\r\n    return Platform.OSX\r\n  }\r\n\r\n  get supportedTargets(): Array<string> {\r\n    return [\"dmg\", \"mas\"]\r\n  }\r\n\r\n  async pack(outDir: string, arch: Arch, targets: Array<string>, postAsyncTasks: Array<Promise<any>>): Promise<any> {\r\n    const packOptions = this.computePackOptions(outDir, this.computeAppOutDir(outDir, arch), arch)\r\n    let nonMasPromise: Promise<any> | null = null\r\n    if (targets.length > 1 || targets[0] !== \"mas\") {\r\n      const appOutDir = this.computeAppOutDir(outDir, arch)\r\n      nonMasPromise = this.doPack(packOptions, outDir, appOutDir, arch, this.customBuildOptions)\r\n        .then(() => this.sign(appOutDir, null))\r\n        .then(() => {\r\n          this.packageInDistributableFormat(appOutDir, targets, postAsyncTasks)\r\n        })\r\n    }\r\n\r\n    if (targets.includes(\"mas\")) {\r\n      // osx-sign - disable warning\r\n      const appOutDir = path.join(outDir, \"mas\")\r\n      const masBuildOptions = deepAssign({}, this.customBuildOptions, (<any>this.devMetadata.build)[\"mas\"])\r\n      await this.doPack(Object.assign({}, packOptions, {platform: \"mas\", \"osx-sign\": false, generateFinalBasename: function () { return \"mas\" }}), outDir, appOutDir, arch, masBuildOptions)\r\n      await this.sign(appOutDir, masBuildOptions)\r\n    }\r\n\r\n    if (nonMasPromise != null) {\r\n      await nonMasPromise\r\n    }\r\n  }\r\n\r\n  private static async findIdentity(certType: CertType, name?: string | null): Promise<string | null> {\r\n    let identity = process.env.CSC_NAME || name\r\n    if (isEmptyOrSpaces(identity)) {\r\n      if (process.env.CSC_IDENTITY_AUTO_DISCOVERY === \"false\") {\r\n        return null\r\n      }\r\n      return await findIdentity(certType)\r\n    }\r\n    else {\r\n      identity = identity.trim()\r\n      for (let prefix of appleCertificatePrefixes) {\r\n        checkPrefix(identity, prefix)\r\n      }\r\n      const result = await findIdentity(certType, identity)\r\n      if (result == null) {\r\n        throw new Error(`Identity name \"${identity}\" is specified, but no valid identity with this name in the keychain`)\r\n      }\r\n      return result\r\n    }\r\n  }\r\n\r\n  private async sign(appOutDir: string, masOptions: MasBuildOptions | null): Promise<void> {\r\n    let codeSigningInfo = await this.codeSigningInfo\r\n    if (codeSigningInfo == null) {\r\n      if (process.env.CSC_LINK != null) {\r\n        throw new Error(\"codeSigningInfo is null, but CSC_LINK defined\")\r\n      }\r\n\r\n      const identity = await OsXPackager.findIdentity(masOptions == null ? \"Developer ID Application\" : \"3rd Party Mac Developer Application\", this.customBuildOptions.identity)\r\n      if (identity == null) {\r\n        const message = \"App is not signed: CSC_LINK or CSC_NAME are not specified, and no valid identity in the keychain, see https://github.com/electron-userland/electron-builder/wiki/Code-Signing\"\r\n        if (masOptions == null) {\r\n          warn(message)\r\n          return\r\n        }\r\n        else {\r\n          throw new Error(message)\r\n        }\r\n      }\r\n\r\n      if (masOptions != null) {\r\n        const installerName = masOptions == null ? null : (await OsXPackager.findIdentity(\"3rd Party Mac Developer Installer\", this.customBuildOptions.identity))\r\n        if (installerName == null) {\r\n          throw new Error(\"Cannot find valid installer certificate: CSC_LINK or CSC_NAME are not specified, and no valid identity in the keychain, see https://github.com/electron-userland/electron-builder/wiki/Code-Signing\")\r\n        }\r\n\r\n        codeSigningInfo = {\r\n          name: identity,\r\n          installerName: installerName,\r\n        }\r\n      }\r\n      else {\r\n        codeSigningInfo = {\r\n          name: identity,\r\n        }\r\n      }\r\n    }\r\n    else {\r\n      if (codeSigningInfo.name == null && masOptions == null) {\r\n        throw new Error(\"codeSigningInfo.name is null, but CSC_LINK defined\")\r\n      }\r\n      if (masOptions != null && codeSigningInfo.installerName == null) {\r\n        throw new Error(\"Signing is required for mas builds but CSC_INSTALLER_LINK is not specified\")\r\n      }\r\n    }\r\n\r\n    const identity = codeSigningInfo.name\r\n    log(`Signing app (identity: ${identity})`)\r\n\r\n    const baseSignOptions: BaseSignOptions = {\r\n      app: path.join(appOutDir, `${this.appName}.app`),\r\n      platform: masOptions == null ? \"darwin\" : \"mas\",\r\n      keychain: <any>codeSigningInfo.keychainName,\r\n      version: this.info.electronVersion\r\n    }\r\n\r\n    const signOptions = Object.assign({\r\n      identity: identity,\r\n    }, (<any>this.devMetadata.build)[\"osx-sign\"], baseSignOptions)\r\n\r\n    const resourceList = await this.resourceList\r\n\r\n    const customSignOptions = masOptions || this.customBuildOptions\r\n    if (customSignOptions.entitlements != null) {\r\n      signOptions.entitlements = customSignOptions.entitlements\r\n    }\r\n    else {\r\n      const p = `entitlements.${masOptions == null ? \"osx\" : \"mas\"}.plist`\r\n      if (resourceList.includes(p)) {\r\n        signOptions.entitlements = path.join(this.buildResourcesDir, p)\r\n      }\r\n    }\r\n\r\n    if (customSignOptions.entitlementsInherit != null) {\r\n      signOptions[\"entitlements-inherit\"] = customSignOptions.entitlementsInherit\r\n    }\r\n    else {\r\n      const p = `entitlements.${masOptions == null ? \"osx\" : \"mas\"}.inherit.plist`\r\n      if (resourceList.includes(p)) {\r\n        signOptions[\"entitlements-inherit\"] = path.join(this.buildResourcesDir, p)\r\n      }\r\n    }\r\n\r\n    await this.doSign(signOptions)\r\n\r\n    if (masOptions != null) {\r\n      const pkg = path.join(appOutDir, `${this.appName}-${this.metadata.version}.pkg`)\r\n      await this.doFlat(Object.assign({\r\n        pkg: pkg,\r\n        identity: codeSigningInfo.installerName,\r\n      }, baseSignOptions))\r\n      this.dispatchArtifactCreated(pkg, `${this.metadata.name}-${this.metadata.version}.pkg`)\r\n    }\r\n  }\r\n\r\n  protected async doSign(opts: SignOptions): Promise<any> {\r\n    return signAsync(opts)\r\n  }\r\n\r\n  protected async doFlat(opts: FlatOptions): Promise<any> {\r\n    return flatAsync(opts)\r\n  }\r\n\r\n  protected async computeEffectiveDistOptions(appOutDir: string): Promise<appdmg.Specification> {\r\n    const specification: appdmg.Specification = deepAssign({\r\n      title: this.appName,\r\n      \"icon-size\": 80,\r\n      contents: [\r\n        {\r\n          \"x\": 410, \"y\": 220, \"type\": \"link\", \"path\": \"/Applications\"\r\n        },\r\n        {\r\n          \"x\": 130, \"y\": 220, \"type\": \"file\"\r\n        }\r\n      ],\r\n      format: this.devMetadata.build.compression === \"store\" ? \"UDRO\" : \"UDBZ\",\r\n    }, this.customBuildOptions)\r\n\r\n    if (!(\"icon\" in this.customBuildOptions)) {\r\n      const resourceList = await this.resourceList\r\n      if (resourceList.includes(\"icon.icns\")) {\r\n        specification.icon = path.join(this.buildResourcesDir, \"icon.icns\")\r\n      }\r\n      else {\r\n        warn(\"Application icon is not set, default Electron icon will be used\")\r\n      }\r\n    }\r\n\r\n    if (!(\"background\" in this.customBuildOptions)) {\r\n      const resourceList = await this.resourceList\r\n      if (resourceList.includes(\"background.png\")) {\r\n        specification.background = path.join(this.buildResourcesDir, \"background.png\")\r\n      }\r\n    }\r\n\r\n    specification.contents[1].path = path.join(appOutDir, this.appName + \".app\")\r\n    return specification\r\n  }\r\n\r\n  protected packageInDistributableFormat(appOutDir: string, targets: Array<string>, promises: Array<Promise<any>>): void {\r\n    for (let target of targets) {\r\n      if (target === \"dmg\" || target === \"default\") {\r\n        promises.push(this.createDmg(appOutDir))\r\n      }\r\n\r\n      if (target !== \"mas\" && target !== \"dmg\") {\r\n        const format = target === \"default\" ? \"zip\" : target\r\n        log(`Creating OS X ${format}`)\r\n        // for default we use mac to be compatible with Squirrel.Mac\r\n        const classifier = target === \"default\" ? \"mac\" : \"osx\"\r\n        // we use app name here - see https://github.com/electron-userland/electron-builder/pull/204\r\n        const outFile = path.join(appOutDir, `${this.appName}-${this.metadata.version}-${classifier}.${format}`)\r\n        promises.push(this.archiveApp(format, appOutDir, outFile)\r\n          .then(() => this.dispatchArtifactCreated(outFile, `${this.metadata.name}-${this.metadata.version}-${classifier}.${format}`)))\r\n      }\r\n    }\r\n  }\r\n\r\n  private async createDmg(appOutDir: string) {\r\n    const artifactPath = path.join(appOutDir, `${this.appName}-${this.metadata.version}.dmg`)\r\n    await new BluebirdPromise<any>(async(resolve, reject) => {\r\n      log(\"Creating DMG\")\r\n      const dmgOptions = {\r\n        target: artifactPath,\r\n        basepath: this.projectDir,\r\n        specification: await this.computeEffectiveDistOptions(appOutDir),\r\n      }\r\n\r\n      if (debug.enabled) {\r\n        debug(`appdmg: ${JSON.stringify(dmgOptions, <any>null, 2)}`)\r\n      }\r\n\r\n      const emitter = require(\"appdmg\")(dmgOptions)\r\n      emitter.on(\"error\", reject)\r\n      emitter.on(\"finish\", () => resolve())\r\n      if (debug.enabled) {\r\n        emitter.on(\"progress\", (info: any) => {\r\n          if (info.type === \"step-begin\") {\r\n            debug(`appdmg: [${info.current}] ${info.title}`)\r\n          }\r\n        })\r\n      }\r\n    })\r\n\r\n    this.dispatchArtifactCreated(artifactPath, `${this.metadata.name}-${this.metadata.version}.dmg`)\r\n  }\r\n}\r\n\r\nfunction checkPrefix(name: string, prefix: string) {\r\n  if (name.startsWith(prefix)) {\r\n    throw new Error(`Please remove prefix \"${prefix}\" from the specified name — appropriate certificate will be chosen automatically`)\r\n  }\r\n}"
  ]
}
